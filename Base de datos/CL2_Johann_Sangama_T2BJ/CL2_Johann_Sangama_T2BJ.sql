--BASE DE DATOS
IF DB_ID('AGENCIA') IS NOT NULL
BEGIN
	USE master
	DROP DATABASE AGENCIA
END

CREATE DATABASE AGENCIA
GO

--Activando la base de datos AGENCIA
USE AGENCIA
GO

--Creando las tablas
CREATE TABLE AEROLINEA(
	RUC			CHAR(11)		NOT NULL,
	NOMBRE		VARCHAR(40)		NOT NULL
)
GO


CREATE TABLE AVION(
	IDAVION		CHAR(5)			NOT NULL,
	RUC			CHAR(11)		NOT NULL,
	COMPAÑIA	VARCHAR(40)		NOT NULL,
	TIPO		VARCHAR(30)		NOT NULL,
	PASAJEROS	INT				NOT NULL
)
GO

CREATE TABLE TARIFA(
	CLASE		VARCHAR(20)		NOT NULL,
	PRECIO		MONEY			NOT NULL,
	IMPUESTO	MONEY			NOT NULL
)
GO

CREATE TABLE RESERVA(
	IDRESERVA	INT				IDENTITY NOT NULL,
	COSTO		MONEY			DEFAULT 0,
	FECHA		DATE			DEFAULT GETDATE()
)
GO

CREATE TABLE PASAJERO(
	IDPASAJERO	CHAR(5)			NOT NULL,
	NOMBRES		VARCHAR(50)		NOT NULL,
	IDPAIS		CHAR(4)			NOT NULL,
	TELEFONO	CHAR(15)		NOT NULL,
	EMAIL		VARCHAR(50)		NOT NULL	
)
GO

CREATE TABLE PAIS(
	IDPAIS		CHAR(4)			NOT NULL,
	PAIS		VARCHAR(30)		NOT NULL	
)
GO

CREATE TABLE ASIENTO(
	NUMVUELO	INT				NOT NULL,
	LETRA		CHAR(2)			NOT NULL,
	FILA		INT				NOT NULL
)
GO

CREATE TABLE PAGO(
	NUMPAGO		INT				NOT NULL,
	IDRESERVA	INT				NOT NULL,
	IDPASAJERO	CHAR(5)			NOT NULL,
	FECHA		DATE			NOT NULL,
	MONTO		MONEY			NOT NULL	
)
GO

CREATE TABLE AEROPUERTO(
	IDAERO		CHAR(5)			NOT NULL,
	NOMBRE		VARCHAR(40)		NOT NULL,
	IDPAIS		CHAR(4)			NOT NULL
)
GO

CREATE TABLE VUELO(
	NUMVUELO	INT				NOT NULL,
	IDAERO		CHAR(5)			NOT NULL,
	IDRESERVA	INT				NOT NULL,
	IDAVION		CHAR(5)			NOT NULL,
	CLASE		VARCHAR(20)		NOT NULL	
)
GO
--Implementado las Llaves Primarias
ALTER TABLE AEROLINEA
	ADD PRIMARY KEY NONCLUSTERED (RUC)
ALTER TABLE AVION
	ADD PRIMARY KEY NONCLUSTERED (IDAVION)
ALTER TABLE AEROPUERTO
	ADD PRIMARY KEY NONCLUSTERED (IDAERO)
ALTER TABLE TARIFA
	ADD PRIMARY KEY NONCLUSTERED (CLASE)
ALTER TABLE VUELO
	ADD PRIMARY KEY NONCLUSTERED (NUMVUELO,IDAERO,IDRESERVA,IDAVION)
ALTER TABLE RESERVA
	ADD PRIMARY KEY NONCLUSTERED (IDRESERVA)
ALTER TABLE PAIS
	ADD PRIMARY KEY NONCLUSTERED (IDPAIS)
ALTER TABLE ASIENTO
	ADD PRIMARY KEY NONCLUSTERED (NUMVUELO)
ALTER TABLE PASAJERO
	ADD PRIMARY KEY NONCLUSTERED (IDPASAJERO)
ALTER TABLE PAGO
	ADD PRIMARY KEY NONCLUSTERED (NUMPAGO)
GO

--Implementando las llaves Secundarias
ALTER TABLE PAGO
	ADD FOREIGN KEY (IDRESERVA) REFERENCES RESERVA
ALTER TABLE PAGO
	ADD FOREIGN KEY (IDPASAJERO) REFERENCES PASAJERO
ALTER TABLE AVION
	ADD FOREIGN KEY (RUC) REFERENCES AEROLINEA
ALTER TABLE VUELO
	ADD FOREIGN KEY (IDAERO) REFERENCES AEROPUERTO
ALTER TABLE VUELO
	ADD FOREIGN KEY (IDRESERVA) REFERENCES RESERVA
ALTER TABLE VUELO
	ADD FOREIGN KEY (IDAVION) REFERENCES AVION
ALTER TABLE VUELO
	ADD FOREIGN KEY (CLASE) REFERENCES TARIFA
ALTER TABLE VUELO
	ADD FOREIGN KEY (NUMVUELO) REFERENCES ASIENTO
ALTER TABLE AEROPUERTO
	ADD FOREIGN KEY (IDPAIS) REFERENCES PAIS
ALTER TABLE PASAJERO
	ADD FOREIGN KEY (IDPAIS) REFERENCES PAIS
GO

------------------------------------------------

--Insertando registros
INSERT INTO AEROLINEA VALUES('10123456789','LAN PERU')
INSERT INTO AEROLINEA VALUES('10123456710','AEROPERU')
INSERT INTO AEROLINEA VALUES('10123456711','TACA')
INSERT INTO AEROLINEA VALUES('10123456712','BIRD PERU')
INSERT INTO AEROLINEA VALUES('10123456713','LAN CUSCO')


INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0001','PERU')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0002','ARGENTINA')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0003','CHILE')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0004','ECUADOR')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0005','BRASIL')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0006','VENEZUELA')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0007','PARAGUAY')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0008','URUGUAY')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0009','BOLIVIA')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0010','MEXICO')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0011','HONDURAS')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0012','EEUU')
INSERT INTO PAIS (IDPAIS,PAIS) VALUES('0013','PUERTO RICO')


SET DATEFORMAT DMY
GO

INSERT INTO RESERVA (COSTO,FECHA)
	VALUES	(0,'01/10/19'),
			(0,'06/10/19'),
			(0,'14/11/19'),
			(0,'16/11/19'),
			(0,'12/12/19'),
			(0,'17/12/19'),
			(0,'14/01/20'),
			(0,'15/01/20'),
			(0,'01/02/20'),
			(0,'02/04/20'),
			(0,'09/04/20'),
			(0,'01/08/20'),
			(0,GETDATE())
GO
		
INSERT INTO PASAJERO
	VALUES('P0001','ANGELA TORRES LAZARO','0001','999999999','ATORRES@HOTMAIL.COM'),
	('P0002','FERNANDA TORRES LAZARO','0001','999999999','FTORRES@HOTMAIL.COM'),
	('P0003','MARIA ZAMORA MEJIA','0005','957564526','MZAMORA@GMAIL.COM'),
	('P0004','GUADALUPE ACOSTA FERRER','0002','957564526','GACOSTA@HOTMAIL.COM'),
	('P0005','LUZ LAZARO MENOR','0001','999999999','LLAZARO@GMAIL.COM'),
	('P0006','KARLA GALLEGOS SILVA','0007','957564526','KGALLEGOS@HOTMAIL.COM'),
	('P0007','NERY CALLE DE LA CRUZ','0010','957564526','NCALLE@GMAIL.COM'),
	('P0008','HEIDI RENGIFO REATEGUI','0004','957564526','HRENGIFO@HOTMAIL.COM'),
	('P0009','MARISOL DIAZ ZAMBRANO','0004','957564526','MDIAZ@GMAIL.COM'),
	('P0010','LINDA TUME VARAS','0008','957564526','LTUME@HOTMAIL.COM')
GO

INSERT INTO PAGO 
	VALUES (1,1,'P0005','01/10/19',500),
	 (2,2,'P0003','06/10/19',900),
	 (3,2,'P0008','14/11/19',500),
	 (4,3,'P0002','16/11/19',1200),
	 (5,3,'P0001','12/12/19',1500),
	 (6,5,'P0006','17/12/19',590),
	 (7,6,'P0003','14/01/20',400),
	 (8,5,'P0003','15/01/20',1300),
	 (9,7,'P0008','01/02/20',1000),
	 (10,3,'P0002','02/04/20',1800),
	 (11,8,'P0001','09/04/20',1200),
	 (12,9,'P0006','01/08/20',400),
	 (13,9,'P0003',GETDATE()+1,800)
GO
  
INSERT INTO AEROPUERTO
	VALUES('AE01','BARILOCHE','0002'),
	('AE02','MAR DEL PLATA','0002'),
	('AE03','JORGE CHAVEZ','0001'),
	('AE04','SANTIAGO','0003'),
	('AE05','AICM','0010'),
	('AE06','JOSE JOAQUIN DE OLMEDO','0004'),
	('AE07','SIMON BOLIVAR','0006'),
	('AE08','SAO PAULO CONGONHAS','0005'),
	('AE09','SILVIO PETTIROSSI','0007'),
	('AE10','CARRASCO PUERTA DEL SUR','0008')
GO	

INSERT INTO TARIFA
	VALUES('COMERCIAL',150,27),
	('EJECUTIVA',420,75.6),
	('PRIMERA CLASE',1390,250.2)
GO


INSERT INTO AVION
	VALUES('101','10123456789','LAN PERU','COMERCIAL',2500),
	('102','10123456710','AEROPERU','CARGA',1500),
	('103','10123456711','TACA','CARGA',3500),
	('104','10123456712','BIRD PERU','COMERCIAL',2000),
	('105','10123456713','LAN CUSCO','CARGA',2750),
	('106','10123456789','LAN PERU','CARGA',1300),
	('107','10123456710','AEROPERU','COMERCIAL',2500),
	('108','10123456711','TACA','CARGA',1000),
	('109','10123456712','BIRD PERU','COMERCIAL',3200),
	('110','10123456713','LAN CUSCO','CARGA',3250)
GO	

INSERT INTO ASIENTO
	VALUES(101,'A',1),
	(102,'B',2),
	(103,'C',3),
	(104,'D',4),
	(105,'E',5),
	(106,'F',6),
	(107,'G',7),
	(108,'H',8),
	(109,'I',9),
	(110,'J',10)
GO

INSERT INTO VUELO
	VALUES(101,'AE01',1,'101','COMERCIAL'),
	(102,'AE02',2,'102','COMERCIAL'),
	(103,'AE03',3,'103','PRIMERA CLASE'),
	(104,'AE04',4,'104','EJECUTIVA'),
	(105,'AE05',5,'105','COMERCIAL'),
	(106,'AE06',6,'106','PRIMERA CLASE'),
	(107,'AE07',7,'107','EJECUTIVA'),
	(108,'AE08',8,'108','COMERCIAL'),
	(109,'AE09',9,'109','EJECUTIVA'),
	(110,'AE10',10,'110','PRIMERA CLASE')
GO

SELECT NUMVUELO AS NUMERO, IDAERO AS AEREOPUERTO, IDRESERVA AS RESERVA, IDAVION AS AVION, CLASE AS CLASE FROM VUELO
	WHERE CLASE='PRIMERA CLASE'
GO

SELECT IDAVION AS AVION, RUC AS RUC, COMPAÑIA AS COMPAÑIA, TIPO AS TIPO, PASAJEROS AS PASAJEROS FROM AVION
	WHERE COMPAÑIA LIKE 'LAN%'
GO

SELECT NUMPAGO AS PAGO, IDRESERVA AS RESERVA, IDPASAJERO AS PASAJERO, FECHA AS FECHA, MONTO AS MONTO FROM PAGO
	WHERE MONTO >500 AND MONTO<1000
GO

SELECT NUMVUELO AS VUELO, LETRA AS LETRA, FILA AS FILA FROM ASIENTO
	WHERE FILA BETWEEN 3 AND 9
GO

SELECT * FROM AEROPUERTO
ORDER BY NOMBRE;

CREATE PROC INSERCION_TARIFA
(
@CLASE		VARCHAR(20),
@PRECIO		MONEY,
@IMPUESTO	MONEY
)
AS
BEGIN 
INSERT INTO TARIFA(CLASE,PRECIO,IMPUESTO)
VALUES(@CLASE,@PRECIO,@IMPUESTO)
END

EXEC INSERCION_TARIFA 'ECONOMICO', 50,13
SELECT * FROM TARIFA

CREATE PROCEDURE SUMA_TOTAL
AS
SELECT SUM(MONTO) AS [SUMA TOTAL]
FROM PAGO

SELECT*FROM PAGO
EXECUTE SUMA_TOTAL

CREATE PROC PROC_ASIENTO
@NUMVUELO	INT,
@LETRA		CHAR(2),
@FILA		INT
AS
BEGIN
	INSERT INTO ASIENTO VALUES (@NUMVUELO,@LETRA,@FILA)
END
GO

EXEC PROC_ASIENTO 209,'B',20
SELECT*FROM ASIENTO
